name: Verify Proofs and Traceability

on:
  push:
  pull_request:
    branches: [main]
  schedule:
    - cron: '03 11 * * 5'
  workflow_dispatch:

jobs:
  verify-proofs:
    runs-on: ubuntu-latest
    steps:
      - name: Update apt cache
        run: sudo apt-get update

      - name: Install Linux packages
        run: sudo apt-get install libgtk2.0-dev

      - name: Checkout pkd-formal
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Checkout PKD specification
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: fedi-e2ee/public-key-directory-specification
          path: specifications/public-key-directory-specification

      - name: Checkout pkd-crypto
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: fedi-e2ee/pkd-crypto
          path: implementations/pkd-crypto

      - name: Checkout pkd-server-php
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: fedi-e2ee/pkd-server-php
          path: implementations/pkd-server-php

      - name: Checkout pkd-client-php
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: fedi-e2ee/pkd-client-php
          path: implementations/pkd-client-php

      - name: Set up OCaml and opam
        run: |
          sudo apt-get update
          sudo apt-get install -y ocaml opam
          opam init --disable-sandboxing -y
          eval "$(opam env)"
          opam update

      - name: Install ProVerif
        run: |
          eval "$(opam env)"
          opam install -y proverif
          opam var bin >> "$GITHUB_PATH"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9  # v1
        with:
          toolchain: stable

      - name: Cache duvet
        id: cache-duvet
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        with:
          path: ~/.cargo/bin/duvet
          key: ${{ runner.os }}-duvet-0.4.1

      - name: Install duvet
        if: steps.cache-duvet.outputs.cache-hit != 'true'
        run: cargo install duvet --version 0.4.1 --locked

      - name: Make scripts executable
        run: chmod +x ./scripts/verify-proofs.sh

      - name: Verify all ProVerif proofs
        run: ./scripts/verify-proofs.sh proofs

      - name: Copy specification to traceability directory
        run: |
          mkdir -p traceability/specifications
          cp -r specifications/public-key-directory-specification traceability/specifications/

      - name: Copy implementations to traceability directory
        run: |
          mkdir -p traceability/implementations
          cp -r implementations/pkd-crypto traceability/implementations/
          cp -r implementations/pkd-server-php traceability/implementations/
          cp -r implementations/pkd-client-php traceability/implementations/

      - name: Generate duvet traceability report
        run: |
          # Pre-download specifications that duvet might have trouble fetching
          mkdir -p .duvet/specifications/www.rfc-editor.org/rfc/
          curl -sS -o .duvet/specifications/www.rfc-editor.org/rfc/rfc9162.txt https://www.rfc-editor.org/rfc/rfc9162.txt
          duvet report

      - name: Check duvet report generated
        run: |
          if [ ! -f traceability-report/index.html ]; then
            echo -e "\033[0;31mDuvet report generation FAILED\033[0m"
            exit 1
          fi
          echo -e "\033[0;32mDuvet traceability report generated successfully\033[0m"

      - name: Check duvet snapshot is up-to-date
        run: |
          if ! git diff --exit-code .duvet/snapshot.txt; then
            echo ""
            echo -e "\033[0;31mDuvet snapshot is stale.\033[0m"
            echo "Run 'duvet report' with all implementation repos present and commit the updated snapshot."
            exit 1
          fi
          echo -e "\033[0;32mDuvet snapshot is up-to-date\033[0m"
